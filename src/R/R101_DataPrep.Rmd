---
title: "Data Preparation and Preprocessing"
author: "Xing Song"
date: "10/06/2022"
output: html_document
---

Let's do some preparation for the class by running the following chunk of codes:

```{r setup, include=FALSE}
#install all the packages for this script
pacman::p_load(
    tidyverse,# data cleaning packages
    finalfit,mice # missing data detection and imputation
)
```

```{r}
df<-readRDS("C:/Users/Administrator/Documents/proj/data/als_aset.rda")
```

## Quantitative and Qualitative Data (11.2.3)

#### Qualitative Data (categorical data)

**nominal data**

```{r nom_data}
ggplot(pt_tbl,aes(x=RACE))+
  geom_histogram(stat="count")
```

**ordinal**

```{r ord_data}
##==============================================
# "mutate" function for adding/altering columns
# "case_when" function
##==============================================
#add a new column, "age_group", that groups ages into 5 groups
pt_tbl_add_agegrp<-pt_tbl %>%
  mutate(AGEGRP=case_when(AGE_AT_ALS1DX<65~'AgeGrp1',
                          AGE_AT_ALS1DX>=65&AGE_AT_ALS1DX<70~'AgeGrp2',
                          AGE_AT_ALS1DX>=70&AGE_AT_ALS1DX<75~'AgeGrp3',
                          AGE_AT_ALS1DX>=75&AGE_AT_ALS1DX<80~'AgeGrp4',
                          AGE_AT_ALS1DX>=80~'AgeGrp5'))
#print first 6 rows
head(pt_tbl_add_agegrp)
```

```{r}
##==============================================
# "select" function for subsetting columns
# you can exclude columns by adding a "-" sign
##==============================================
pt_tbl_only_agegrp<-pt_tbl_add_agegrp %>%
  select(PATID,AGEGRP)

ggplot(pt_tbl_only_agegrp,aes(x=AGEGRP))+
  geom_bar(stat="count")
```

**********************************                     

#### Quantitative Data (numerical data)

**discrete data**

```{r}
ggplot(pt_tbl,aes(x=AGE_AT_ALS1DX))+
  geom_histogram(fill="blue",bins = 40)
```

**continuous data**

```{r}
ggplot(pt_tbl,aes(x=AGE_AT_ALS1DX))+
  geom_density(fill="blue")

#5-number summary
summary(pt_tbl$AGE_AT_ALS1DX)
```

**************************************************************************************************
**************************************************************************************************

## Data Preprocessing

General steps for data preprocessing are **Data Integration**, **Data Abstraction**, **Data Cleaning**, **Data Transformation** and **Data Reduction**. 

```{r}
##=========================================================================================
# "ymd" and "difftime" functions from "lubridate" package to calculate date difference
# The "lubridate" package in tidyverse provides functions for operations on dates and times
# more on: https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html
##=======================================================================================
df<-df %>%
  mutate(DAYS_ALS1DX_TO_DEATH = difftime(lubridate::ymd(OUTCOME_DATE), lubridate::ymd(DX_DATE1), units = "days"))

head(df)

```

**********************************************************************************

### Data Cleaning 

#### Check for Data Duplications

```{r}
##========================================================
# "group_by" function to collect stratified summaries
#
# "arrange" function to order data.frame according 
#  one/many index columns
##========================================================
df %>%
  group_by(PATID) %>% 
  filter(n()>1) %>%
  arrange(PATID) %>%
  ungroup
```



```{r}
##========================================================
# "group_by"+"filter" to de-duplicate
##========================================================
df<-df %>%
  group_by(PATID) %>%
  filter(DAYS_ALS1DX_TO_DEATH == min(DAYS_ALS1DX_TO_DEATH) | is.na(DAYS_ALS1DX_TO_DEATH)) %>%
  ungroup

df %>%
  group_by(PATID) %>% 
  filter(n()>1) %>%
  arrange(PATID) %>%
  ungroup
```



#### Data Cleaning - Missing Data 

```{r}
##========================================================
# "finalfit" package provides functions that help you quickly create 
# elegant final results tables and plots, including an effective
# way to look at missing patterns
# 
# more on: https://finalfit.org/
##======================================================== 
explanatory = c("SEX","RACE","AGE_AT_ALS1DX","RILUZ_DUR","RILUZ_IND")
dependent = 'MORT_IND'
df %>%
  missing_pattern(dependent,explanatory)
```


```{r}
##=====================================================
# "replace_na" function for quick imputation using
# a constant value
##=====================================================
df<-df %>%
  replace_na(list(RACE='UN'))

df %>%
  missing_pattern(dependent,explanatory)
```


```{r}
df<-df %>%
  replace_na(list(RILUZ_DUR=0))

df %>%
  missing_pattern(dependent,explanatory)
```



### Data Transformation

#### One-hot encoding 
```{r}
##=====================================================
# "spread" function for quick table pivoting
##=====================================================
race_ohe<-df %>% 
  select(PATID,RACE) %>%
  mutate(ind=1) %>%
  spread(RACE,ind, fill = 0)

head(race_ohe)
```

```{r}
##=====================================================
# "rename" function for modifying column names
##=====================================================
race_ohe<-race_ohe %>%
  rename("RACE_white" = "03",
         "RACE_black" = "05",
         "RACE_OT" = "OT",
         "RACE_UN" = "UN"
         )

head(race_ohe)
```

Let's add the numerical representations of one-hot encoded RACE columns, and form the final analytic set:

```{r}
df<-df %>%
  left_join(race_ohe,by="PATID")

head(df)
```


```{r}
saveRDS(df,file="C:/Users/Administrator/Documents/classHMI7001/data/df.rda")
```
